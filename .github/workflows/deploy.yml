name: Build and Deploy HIAT2025 Analysis System

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml
        
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f pyproject.toml ]; then
          pip install -e .
        elif [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install pandas openpyxl PyMuPDF Pillow requests beautifulsoup4 jsonschema
        fi
        
    - name: ğŸ“Š æ£€æŸ¥æ•°æ®æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥å·¥ä½œç›®å½•å†…å®¹:"
        ls -la
        echo "æ£€æŸ¥æ˜¯å¦å­˜åœ¨æå–çš„æ•°æ®:"
        find . -name "content_extraction_full_*.json" -o -name "extracted_content" -type d || echo "æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶"
        
    - name: ğŸ”„ è¿è¡Œæ•°æ®æå–ï¼ˆå¦‚æœéœ€è¦ï¼‰
      run: |
        if [ ! -f content_extraction_full_*.json ]; then
          echo "æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶ï¼Œå°è¯•è¿è¡Œæ•°æ®æå–..."
          if [ -f "advanced_pdf_content_extractor.py" ]; then
            echo "è¿è¡ŒPDFå†…å®¹æå–å™¨..."
            python advanced_pdf_content_extractor.py || echo "æ•°æ®æå–å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®"
          else
            echo "æœªæ‰¾åˆ°æå–å™¨ï¼Œå°†ä½¿ç”¨å‰ç«¯æ¨¡æ‹Ÿæ•°æ®"
          fi
        else
          echo "æ‰¾åˆ°ç°æœ‰æ•°æ®æ–‡ä»¶"
        fi
        
    - name: ğŸ› ï¸ å‡†å¤‡å‰ç«¯æ•°æ®
      run: |
        echo "å‡†å¤‡å‰ç«¯æ•°æ®..."
        python scripts/prepare_data.py || echo "æ•°æ®å‡†å¤‡å¤±è´¥ï¼Œå‰ç«¯å°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®"
        
    - name: ğŸ“ éªŒè¯è¾“å‡ºç»“æ„
      run: |
        echo "éªŒè¯docsç›®å½•ç»“æ„:"
        ls -la docs/ || echo "docsç›®å½•ä¸å­˜åœ¨"
        if [ -d "docs/data" ]; then
          echo "æ•°æ®æ–‡ä»¶:"
          ls -la docs/data/
        fi
        if [ -d "docs/images" ]; then
          echo "å›¾ç‰‡æ–‡ä»¶æ•°é‡:"
          ls docs/images/ | wc -l
        fi
        
    - name: ğŸŒ è®¾ç½®GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¤ ä¸Šä¼ é¡µé¢æ„ä»¶
      uses: actions/upload-pages-artifact@v4
      with:
        path: docs/

  # éƒ¨ç½²ä½œä¸š
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
